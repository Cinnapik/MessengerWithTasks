<Window x:Class="MessengerApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Messenger" Height="760" Width="1200" WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BgBrush}">
  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="64"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <!-- Верхняя панель -->
    <Border Grid.Row="0" Background="{DynamicResource PanelBrush}" Padding="10">
      <DockPanel>
        <TextBlock Text="{Binding TitleBarDisplay}" FontWeight="Bold" VerticalAlignment="Center" />
        <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
          <Border Width="40" Height="40" CornerRadius="20" Background="{Binding CurrentUser.AvatarColor}" Margin="0,0,8,0">
            <TextBlock Text="{Binding CurrentUser.DisplayName, Converter={StaticResource InitialsConverter}}" 
                       HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="White" FontWeight="Bold"/>
          </Border>
          <Button Content="Выйти" Command="{Binding SignOutCommand}" Background="#FF374151" Foreground="White" Padding="8" />
        </StackPanel>
      </DockPanel>
    </Border>

    <!-- Контент -->
    <Grid Grid.Row="1">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="300"/>
        <ColumnDefinition Width="*"/>
        <ColumnDefinition Width="360"/>
      </Grid.ColumnDefinitions>

      <!-- Список чатов -->
      <Border Grid.Column="0" Background="{DynamicResource PanelBrush}" Padding="12">
        <StackPanel>
          <TextBlock Text="Чаты" FontSize="18" FontWeight="Bold" Margin="4"/>
          <ListBox ItemsSource="{Binding Chats}" SelectedItem="{Binding SelectedChat}" Height="640" Margin="0,8,0,0">
            <ListBox.ItemTemplate>
              <DataTemplate>
                <StackPanel Orientation="Horizontal" Margin="6">
                  <Border Width="40" Height="40" CornerRadius="20" Background="#FF374151" VerticalAlignment="Center">
                    <TextBlock Text="{Binding}" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="White"/>
                  </Border>
                  <StackPanel Margin="8,0,0,0">
                    <TextBlock Text="{Binding}" FontWeight="SemiBold"/>
                    <TextBlock Text="Последнее сообщение..." Foreground="{DynamicResource TextMutedBrush}" FontSize="12"/>
                  </StackPanel>
                </StackPanel>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>
        </StackPanel>
      </Border>

      <!-- Центр: сообщения -->
      <Border Grid.Column="1" Background="{DynamicResource BgBrush}" Padding="12">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>

          <TextBlock Text="{Binding SelectedChat}" FontSize="18" FontWeight="Bold" Margin="4"/>

          <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="0,8,0,0">
            <ItemsControl ItemsSource="{Binding ChatVM.Messages}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Grid Margin="8">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="Auto"/>
                      <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Border Grid.Column="1" Background="{Binding IsSentByMe, Converter={StaticResource BoolToBrushConverter}}" 
                            Padding="12" CornerRadius="12" MaxWidth="760">
                      <StackPanel>
                        <TextBlock Text="{Binding Sender}" Foreground="{DynamicResource TextMutedBrush}" FontSize="12"/>
                        <TextBlock Text="{Binding Content}" TextWrapping="Wrap" Margin="0,6,0,0"/>
                        <TextBlock Text="{Binding Timestamp, StringFormat=t}" Foreground="{DynamicResource TextMutedBrush}" FontSize="10" HorizontalAlignment="Right" Margin="0,6,0,0"/>
                      </StackPanel>
                    </Border>
                  </Grid>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>

          <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,8,0,0" HorizontalAlignment="Left">
            <TextBox Text="{Binding ChatVM.NewMessage, UpdateSourceTrigger=PropertyChanged}" AcceptsReturn="True" Height="48" Width="820" VerticalContentAlignment="Center"/>
            <Button Content="Отправить" Command="{Binding ChatVM.SendMessageCommand}" Style="{StaticResource SendButton}" Margin="12,0,0,0"/>
          </StackPanel>
        </Grid>
      </Border>

      <!-- Правая панель: задачи и помощник -->
      <Border Grid.Column="2" Background="{DynamicResource PanelBrush}" Padding="12">
        <StackPanel>
          <TextBlock Text="Задачи" FontSize="16" FontWeight="Bold"/>
          <StackPanel Orientation="Horizontal" Margin="0,8,0,6">
            <TextBox Text="{Binding TasksVM.NewTaskTitle}" Width="220"/>
            <Button Content="Добавить" Command="{Binding TasksVM.AddTaskCommand}" Margin="8,0,0,0"/>
          </StackPanel>

          <ItemsControl ItemsSource="{Binding TasksVM.Tasks}" Margin="0,6,0,0">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <DockPanel Margin="4">
                  <CheckBox IsChecked="{Binding IsDone}" VerticalAlignment="Center" Margin="4"/>
                  <TextBlock Text="{Binding Title}" VerticalAlignment="Center" Margin="8,0,0,0"/>
                </DockPanel>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <Separator Margin="0,12"/>
          <TextBlock Text="Помощник" FontSize="16" FontWeight="Bold" Margin="0,6,0,0"/>
          <TextBox Text="{Binding AssistantVM.Query}" Height="44" Margin="0,8,0,0"/>
          <Button Content="Спросить" Command="{Binding AssistantVM.AskCommand}" Margin="0,8,0,0"/>
          <ScrollViewer Height="160" Margin="0,8,0,0" Background="{DynamicResource BgBrush}">
            <TextBlock Text="{Binding AssistantVM.Response}" TextWrapping="Wrap" Padding="8"/>
          </ScrollViewer>
        </StackPanel>
      </Border>
    </Grid>
  </Grid>
</Window>
